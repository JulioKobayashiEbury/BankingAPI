@startuml
title Process New Automatic Debit - PUT /accounts/:account_id/debit

actor Requester
boundary AccountPutAutomaticDebitHandler <<accountHandler.go>>
control AuthorizeService <<serviceAuthorize.go>>
control AutoDebitService <<serviceAutomaticDebit.go>>
entity AutoDebitFirestore <<model/automaticDebit/firestore.go>>

activate Requester
Requester -> AccountPutAutomaticDebitHandler : PUT /accounts/:account_id/debit (Body: AutomaticDebitRequest)
activate AccountPutAutomaticDebitHandler
AccountPutAutomaticDebitHandler -> AuthorizeService : Authorize(Cookie)
activate AuthorizeService
AuthorizeService --> AccountPutAutomaticDebitHandler : Claims / Error
deactivate AuthorizeService
alt Authorization Failed
    AccountPutAutomaticDebitHandler --> Requester : HTTP Error Response
else Authorization Succeeded
    AccountPutAutomaticDebitHandler -> AutoDebitFirestore : NewAutoDebitFirestore(DatabaseClient)
    activate AutoDebitFirestore
    AutoDebitFirestore -> AccountPutAutomaticDebitHandler : automaticdebit.AutoDebitFirestore
    ' Withdrawal service setup for AutoDebitService is also needed, simplified here for focus
    note right of AutoDebitService : Withdrawal service is needed but not shown for simplicity and focus
    AccountPutAutomaticDebitHandler -> AutoDebitService : NewAutoDebitImpl(autodebitDatabase, withdrawalService)
    activate AutoDebitService
    AutoDebitService -> AccountPutAutomaticDebitHandler : ServiceAutoDebit
    AccountPutAutomaticDebitHandler -> AutoDebitService : ProcessNewAutomaticDebit(newAutoDebitRequest)
    note right of AutoDebitService : newAutoDebitRequest.Account_id is from path param

    AutoDebitService -> AutoDebitService : isValidDate(newAutoDebitRequest.Expiration_date)
    alt Invalid Date Format
        AutoDebitService --> AccountPutAutomaticDebitHandler : Error (Invalid date format)
        AccountPutAutomaticDebitHandler --> Requester : HTTP Error Response
    else Valid Date Format
        AutoDebitService -> AutoDebitFirestore : Create(newAutoDebitRequest)
        AutoDebitFirestore --> AutoDebitService : responseID / Error
        alt Create AutoDebit Record Failed
            AutoDebitService --> AccountPutAutomaticDebitHandler : Error
            AccountPutAutomaticDebitHandler --> Requester : HTTP Error Response
        else Create AutoDebit Record Succeeded
            AutoDebitService -> AutoDebitFirestore : Get(responseID)
            AutoDebitFirestore --> AutoDebitService : autoDebitResponseData / Error
            deactivate AutoDebitFirestore
            alt Get Created AutoDebit Failed
                AutoDebitService --> AccountPutAutomaticDebitHandler : Error
                AccountPutAutomaticDebitHandler --> Requester : HTTP Error Response
            else Get Created AutoDebit Succeeded
                AutoDebitService --> AccountPutAutomaticDebitHandler : autoDebitResponse
                AccountPutAutomaticDebitHandler --> Requester : HTTP 202 Accepted (autoDebitResponse)
            end
            deactivate AutoDebitService
            deactivate AccountPutAutomaticDebitHandler
        end
    end
end
deactivate Requester

@enduml