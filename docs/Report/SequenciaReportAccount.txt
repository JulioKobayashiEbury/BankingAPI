@startuml
title Generate Account Report - GET /accounts/report/:account_id

actor Requester
boundary AccountGetReportHandler <<accountHandler.go>>
control AuthorizeService <<serviceAuthorize.go>>
control ReportService <<serviceReports.go>>
control AccountService <<serviceAccount.go>>
control DepositService <<serviceDeposit.go>>
control WithdrawalService <<serviceWithdrawal.go>>
control TransferService <<serviceTransfer.go>>
control AutoDebitService <<serviceAutomaticDebit.go>>
entity AccountFirestore <<model/account/firestore.go>>
entity TransferFirestore <<model/transfer/firestore.go>>
entity DepositFirestore <<model/deposit/firestore.go>>
entity WithdrawalFirestore <<model/withdrawal/firestore.go>>
entity AutoDebitFirestore <<model/automaticDebit/firestore.go>>

Requester -> AccountGetReportHandler : GET /accounts/report/:account_id
activate AccountGetReportHandler

AccountGetReportHandler -> AuthorizeService : Authorize(Cookie)
activate AuthorizeService
AuthorizeService -->> AccountGetReportHandler : Claims / Error
deactivate AuthorizeService

alt Authorization Failed
    AccountGetReportHandler -->> Requester : HTTP Error Response
else Authorization Succeeded
    AccountGetReportHandler -> ReportService : GenerateReportByAccount(accountID_from_path)
    activate ReportService
    ReportService -> AccountService : Account(accountID)
    activate AccountService
    AccountService -> AccountFirestore : Get(&accountID)
    activate AccountFirestore
    AccountFirestore -->> AccountService : accountInfo / Error
    deactivate AccountFirestore
    
    alt Get AccountInfo Failed
        AccountService -->> ReportService : Error
        ReportService -->> AccountGetReportHandler : Error
        AccountGetReportHandler -->> Requester : HTTP Error Response
    else Get AccountInfo Succeeded
        AccountService -->> ReportService : accountInfo
        deactivate AccountService
        
        ReportService -> TransferService : GetAllTransfersByAccountID(accountID)
        activate TransferService
        TransferService -> TransferFirestore : GetAll()
        activate TransferFirestore
        TransferFirestore -->> TransferService : allTransfers / Error
        deactivate TransferFirestore
        note right of TransferService : Filters transfers by accountID
        TransferService -->> ReportService : transfers / Error
        deactivate TransferService
        alt Get Transfers Failed
            ReportService -->> AccountGetReportHandler : Error
            AccountGetReportHandler -->> Requester : HTTP Error Response
        else Get Transfers Succeeded
            ReportService -> DepositService : GetAllDepositsByAccountID(accountID)
            activate DepositService
            DepositService -> DepositFirestore : GetAll()
            activate DepositFirestore
            DepositFirestore -->> DepositService : allDeposits / Error
            deactivate DepositFirestore
            note right of DepositService : Filters deposits by accountID
            DepositService -->> ReportService : deposits / Error
            deactivate DepositService

            alt Get Deposits Failed
                ReportService -->> AccountGetReportHandler : Error
                AccountGetReportHandler -->> Requester : HTTP Error Response
            else Get Deposits Succeeded
                 ReportService -> WithdrawalService : GetAllWithdrawalsByAccountID(accountID)
                 activate WithdrawalService
                 WithdrawalService -> WithdrawalFirestore : GetAll()
                 activate WithdrawalFirestore
                 WithdrawalFirestore -->> WithdrawalService : allWithdrawals / Error
                 deactivate WithdrawalFirestore
                 note right of WithdrawalService : Filters withdrawals by accountID
                 WithdrawalService -->> ReportService : withdrawals / Error
                 deactivate WithdrawalService

                 alt Get Withdrawals Failed
                    ReportService -->> AccountGetReportHandler : Error
                    AccountGetReportHandler -->> Requester : HTTP Error Response
                 else Get Withdrawals Succeeded
                    ReportService -> AutoDebitService : GetAllAutoDebitsByAccountID(accountID)
                    activate AutoDebitService
                    AutoDebitService -> AutoDebitFirestore : GetAll()
                    activate AutoDebitFirestore
                    AutoDebitFirestore -->> AutoDebitService : allAutoDebits / Error
                    deactivate AutoDebitFirestore
                    note right of AutoDebitService : Filters autoDebits by accountID
                    AutoDebitService -->> ReportService : automaticDebits / Error
                    deactivate AutoDebitService

                    alt Get AutoDebits Failed
                        ReportService -->> AccountGetReportHandler : Error
                        AccountGetReportHandler -->> Requester : HTTP Error Response
                    else Get AutoDebits Succeeded
                        ReportService -->> AccountGetReportHandler : accountReport
                        AccountGetReportHandler -->> Requester : HTTP 200 OK (accountReport)
                    end
                 end
            end
        end
        
    end
    deactivate ReportService
end
deactivate AccountGetReportHandler
@enduml