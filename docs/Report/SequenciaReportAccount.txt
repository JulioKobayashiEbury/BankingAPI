@startuml
title Generate Account Report - GET /accounts/report/:account_id

actor Requester
boundary AccountGetReportHandler <<accountHandler.go>>
control AuthorizeService <<serviceAuthorize.go>>
control AccountService <<serviceAccount.go>>
control GetFilteredService <<serviceGetFiltered.go>>
entity AccountFirestore <<model/account/firestore.go>>
entity TransferFirestore <<model/transfer/firestore.go>>
entity DepositFirestore <<model/deposit/firestore.go>>
entity WithdrawalFirestore <<model/withdrawal/firestore.go>>
entity AutoDebitFirestore <<model/automaticDebit/firestore.go>>

Requester -> AccountGetReportHandler : GET /accounts/report/:account_id
activate AccountGetReportHandler

AccountGetReportHandler -> AuthorizeService : Authorize(Cookie)
activate AuthorizeService
AuthorizeService -->> AccountGetReportHandler : Claims / Error
deactivate AuthorizeService

alt Authorization Failed
    AccountGetReportHandler -->> Requester : HTTP Error Response
else Authorization Succeeded
    AccountGetReportHandler -> AccountService : Report(accountID_from_path)
    activate AccountService
    
    AccountService -> AccountService : Get(accountID)
    activate AccountService
    AccountService -> AccountFirestore : Get(&accountID)
    activate AccountFirestore
    AccountFirestore -->> AccountService : accountInfo / Error
    deactivate AccountFirestore
    deactivate AccountService
    
    alt Get AccountInfo Failed
        AccountService -->> AccountGetReportHandler : Error
        AccountGetReportHandler -->> Requester : HTTP Error Response
    else Get AccountInfo Succeeded
        
        AccountService -> GetFilteredService : GetAllTransfersByAccountID(accountID)
        activate GetFilteredService
        GetFilteredService -> TransferFirestore : GetAll()
        activate TransferFirestore
        TransferFirestore -->> GetFilteredService : allTransfers / Error
        deactivate TransferFirestore
        note right of GetFilteredService : Filters transfers by accountID
        GetFilteredService -->> AccountService : transfers / Error
        deactivate GetFilteredService
        
        AccountService -> GetFilteredService : GetAllDepositsByAccountID(accountID)
        activate GetFilteredService
        GetFilteredService -> DepositFirestore : GetAll()
        activate DepositFirestore
        DepositFirestore -->> GetFilteredService : allDeposits / Error
        deactivate DepositFirestore
        note right of GetFilteredService : Filters deposits by accountID
        GetFilteredService -->> AccountService : deposits / Error
        deactivate GetFilteredService
        
        AccountService -> GetFilteredService : GetAllWithdrawalsByAccountID(accountID)
        activate GetFilteredService
        GetFilteredService -> WithdrawalFirestore : GetAll()
        activate WithdrawalFirestore
        WithdrawalFirestore -->> GetFilteredService : allWithdrawals / Error
        deactivate WithdrawalFirestore
        note right of GetFilteredService : Filters withdrawals by accountID
        GetFilteredService -->> AccountService : withdrawals / Error
        deactivate GetFilteredService

        AccountService -> GetFilteredService : GetAllAutoDebitsByAccountID(accountID)
        activate GetFilteredService
        GetFilteredService -> AutoDebitFirestore : GetAll()
        activate AutoDebitFirestore
        AutoDebitFirestore -->> GetFilteredService : allAutoDebits / Error
        deactivate AutoDebitFirestore
        note right of GetFilteredService : Filters autoDebits by accountID
        GetFilteredService -->> AccountService : automaticDebits / Error
        deactivate GetFilteredService

        note right of AccountService : Assembles AccountReport from all data
        AccountService -->> AccountGetReportHandler : accountReport
        AccountGetReportHandler -->> Requester : HTTP 200 OK (accountReport)
        
    end
    deactivate AccountService
end
deactivate AccountGetReportHandler
@enduml