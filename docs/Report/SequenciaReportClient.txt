@startuml
title Generate Client Report - GET /clients/:client_id/report

actor Requester
boundary ClientGetReportHandler <<clientHandler.go>>
control AuthorizeService <<serviceAuthorize.go>>
control ReportService <<serviceReports.go>>
control ClientService <<serviceClient.go>>
control AccountService <<serviceAccount.go>>
entity ClientFirestore <<model/client/firestore.go>>
entity AccountFirestore <<model/account/firestore.go>>
' Other DBs for full service init (User, Transfer, Deposit, Withdrawal, AutoDebit)

Requester -> ClientGetReportHandler : GET /clients/:client_id/report
activate ClientGetReportHandler

ClientGetReportHandler -> AuthorizeService : Authorize(Cookie)
activate AuthorizeService
AuthorizeService -->> ClientGetReportHandler : Claims / Error
deactivate AuthorizeService

alt Authorization Failed
    ClientGetReportHandler -->> Requester : HTTP Error Response
else Authorization Succeeded
    ' Initialize DBs (simplified for brevity)
    ClientGetReportHandler -> ReportService : GenerateReportByClient(clientID_from_path)
    activate ReportService
    ReportService -> ClientService : Client(clientID)
    activate ClientService
    ClientService -> ClientFirestore : Get(&clientID)
    activate ClientFirestore
    ClientFirestore -->> ClientService : clientInfo / Error
    deactivate ClientFirestore
    
    alt Get ClientInfo Failed
        ClientService -->> ReportService : Error
        ReportService -->> ClientGetReportHandler : Error
        ClientGetReportHandler -->> Requester : HTTP Error Response
    else Get ClientInfo Succeeded
        ClientService -->> ReportService : clientInfo
        deactivate ClientService
        ReportService -> AccountService : GetAccountsByClientID(clientID)
        activate AccountService
        AccountService -> AccountFirestore : GetAll()
        activate AccountFirestore
        AccountFirestore -->> AccountService : allAccounts / Error
        deactivate AccountFirestore
        note right of AccountService : Filters accounts by clientID
        AccountService -->> ReportService : accounts / Error
        deactivate AccountService
        alt Get Accounts Failed
            ReportService -->> ClientGetReportHandler : Error
            ClientGetReportHandler -->> Requester : HTTP Error Response
        else Get Accounts Succeeded
            ReportService -->> ClientGetReportHandler : clientReport
            ClientGetReportHandler -->> Requester : HTTP 200 OK (clientReport)
        end
    end
    deactivate ReportService
end
deactivate ClientGetReportHandler
@enduml