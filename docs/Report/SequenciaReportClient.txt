@startuml
title Generate Client Report - GET /clients/report/:client_id

actor Requester
boundary ClientGetReportHandler <<clientHandler.go>>
control AuthorizeService <<serviceAuthorize.go>>
control ClientService <<serviceClient.go>>
control GetFilteredService <<serviceGetFiltered.go>>
entity ClientFirestore <<model/client/firestore.go>>
entity AccountFirestore <<model/account/firestore.go>>

Requester -> ClientGetReportHandler : GET /clients/report/:client_id
activate ClientGetReportHandler

ClientGetReportHandler -> AuthorizeService : Authorize(Cookie)
activate AuthorizeService
AuthorizeService -->> ClientGetReportHandler : Claims / Error
deactivate AuthorizeService

alt Authorization Failed
    ClientGetReportHandler -->> Requester : HTTP Error Response
else Authorization Succeeded
    ClientGetReportHandler -> ClientService : Report(clientID_from_path)
    activate ClientService

    ClientService -> ClientService : Get(clientID)
    activate ClientService
    ClientService -> ClientFirestore : Get(&clientID)
    activate ClientFirestore
    ClientFirestore -->> ClientService : clientInfo / Error
    deactivate ClientFirestore
    deactivate ClientService

    alt Get ClientInfo Failed
        ClientService -->> ClientGetReportHandler : Error
        ClientGetReportHandler -->> Requester : HTTP Error Response
    else Get ClientInfo Succeeded
        ClientService -> GetFilteredService : GetAccountsByClientID(clientID)
        activate GetFilteredService
        GetFilteredService -> AccountFirestore : GetAll()
        activate AccountFirestore
        AccountFirestore -->> GetFilteredService : allAccounts / Error
        deactivate AccountFirestore
        note right of GetFilteredService : Filters accounts by clientID
        GetFilteredService -->> ClientService : accounts / Error
        deactivate GetFilteredService

        alt Get Accounts Failed
            ClientService -->> ClientGetReportHandler : Error
            ClientGetReportHandler -->> Requester : HTTP Error Response
        else Get Accounts Succeeded
            note right of ClientService : Assembles ClientReport
            ClientService -->> ClientGetReportHandler : clientReport
            ClientGetReportHandler -->> Requester : HTTP 200 OK (clientReport)
        end
    end
    deactivate ClientService
end
deactivate ClientGetReportHandler
@enduml