@startuml
title Process Deposit - PUT /accounts/:account_id/balance/deposit

actor Requester
boundary AccountPutDepositHandler <<accountHandler.go>>
control AuthorizeService <<serviceAuthorize.go>>
control DepositService <<serviceDeposit.go>>
entity AccountFirestore <<model/account/firestore.go>>
entity DepositFirestore <<model/deposit/firestore.go>>

activate Requester
Requester -> AccountPutDepositHandler : PUT /accounts/:account_id/balance/deposit (Body: DepositRequest)
activate AccountPutDepositHandler
AccountPutDepositHandler -> AuthorizeService : Authorize(Cookie)
activate AuthorizeService
AuthorizeService --> AccountPutDepositHandler : Claims / Error
deactivate AuthorizeService
alt Authorization Failed
    AccountPutDepositHandler --> Requester : HTTP Error Response
else Authorization Succeeded
    
    AccountPutDepositHandler -> DepositService : ProcessDeposit(depositRequest)
    activate DepositService
    note right of DepositService : depositRequest.Account_id is from path param

    DepositService -> DepositService : Account(depositRequest.Account_id)
    DepositService -> AccountFirestore : Get(&depositRequest.Account_id)
    activate AccountFirestore
    AccountFirestore --> DepositService : accountData / Error
    deactivate AccountFirestore
    alt Get Account Failed
        DepositService --> DepositService : Error
        DepositService --> AccountPutDepositHandler : Error
        AccountPutDepositHandler --> Requester : HTTP Error Response
    else Get Account Succeeded
        DepositService --> DepositService : accountResponse
        DepositService -> DepositService : verifyDeposit(depositRequest, accountResponse)
        alt Verification Failed
            DepositService --> AccountPutDepositHandler : Error (e.g. Client/User/Agency ID mismatch)
            AccountPutDepositHandler --> Requester : HTTP Error Response
        else Verification Succeeded
            DepositService -> DepositFirestore : Create(depositRequest)
            activate DepositFirestore
            DepositFirestore --> DepositService : depositID / Error
            alt Create Deposit Record Failed
                DepositService --> AccountPutDepositHandler : Error
                AccountPutDepositHandler --> Requester : HTTP Error Response
            else Create Deposit Record Succeeded
                DepositService -> AccountFirestore : Update(accountResponse with balance + depositRequest.Deposit)
                activate AccountFirestore
                AccountFirestore --> DepositService : nil / Error
                deactivate AccountFirestore
                alt Update Account Balance Failed (Rollback Create Deposit)
                    DepositService -> DepositFirestore : Delete(depositID)
                    DepositFirestore --> DepositService : (ignore error for this rollback attempt)
                    DepositService --> AccountPutDepositHandler : Error
                    AccountPutDepositHandler --> Requester : HTTP Error Response
                else Update Account Balance Succeeded
                    DepositService --> AccountPutDepositHandler : depositID
                    AccountPutDepositHandler --> Requester : HTTP 202 Accepted (depositID)
                end
                deactivate DepositFirestore
            end
        end
    end
    deactivate DepositService
end
deactivate AccountPutDepositHandler
deactivate Requester
@enduml