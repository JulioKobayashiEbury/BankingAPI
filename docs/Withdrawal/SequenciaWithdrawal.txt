@startuml
title Process Withdrawal - PUT /accounts/:account_id/balance/withdrawal

actor Requester
boundary AccountPutWithdrawalHandler <<accountHandler.go>>
control AuthorizeService <<serviceAuthorize.go>>
control WithdrawalService <<serviceWithdrawal.go>>
control WithdrawalService <<serviceGetTypes.go>>
entity AccountFirestore <<model/account/firestore.go>>
entity WithdrawalFirestore <<model/withdrawal/firestore.go>>

activate Requester
Requester -> AccountPutWithdrawalHandler : PUT /accounts/:account_id/balance/withdrawal (Body: WithdrawalRequest)
activate AccountPutWithdrawalHandler
AccountPutWithdrawalHandler -> AuthorizeService : Authorize(Cookie)
activate AuthorizeService
AuthorizeService --> AccountPutWithdrawalHandler : Claims / Error
deactivate AuthorizeService
alt Authorization Failed
    AccountPutWithdrawalHandler --> Requester : HTTP Error Response
else Authorization Succeeded
    
    AccountPutWithdrawalHandler -> WithdrawalService : ProcessWithdrawal(withdrawalRequest)
    activate WithdrawalService
    note right of WithdrawalService : withdrawalRequest.Account_id is from path param

    WithdrawalService -> WithdrawalService : Account(withdrawalRequest.Account_id)
    WithdrawalService -> AccountFirestore : Get(&withdrawalRequest.Account_id)
    activate AccountFirestore
    AccountFirestore --> WithdrawalService : accountData / Error
    deactivate AccountFirestore
    alt Get Account Failed
        WithdrawalService --> WithdrawalService : Error
        WithdrawalService --> AccountPutWithdrawalHandler : Error
        AccountPutWithdrawalHandler --> Requester : HTTP Error Response
    else Get Account Succeeded
        WithdrawalService --> WithdrawalService : accountResponse
        WithdrawalService -> WithdrawalService : verifyWithdrawal(withdrawalRequest, accountResponse)
        alt Verification Failed (e.g. ID mismatch, insufficient funds)
            WithdrawalService --> AccountPutWithdrawalHandler : Error
            AccountPutWithdrawalHandler --> Requester : HTTP Error Response
        else Verification Succeeded
            WithdrawalService -> WithdrawalFirestore : Create(withdrawalRequest)
            activate WithdrawalFirestore
            WithdrawalFirestore --> WithdrawalService : withdrawalID / Error
            deactivate WithdrawalFirestore
            alt Create Withdrawal Record Failed
                WithdrawalService --> AccountPutWithdrawalHandler : Error
                AccountPutWithdrawalHandler --> Requester : HTTP Error Response
            else Create Withdrawal Record Succeeded
                WithdrawalService -> AccountFirestore : Update(accountResponse with balance - withdrawalRequest.Withdrawal)
                activate AccountFirestore
                AccountFirestore --> WithdrawalService : nil / Error
                deactivate AccountFirestore
                alt Update Account Balance Failed (Rollback Create Withdrawal)
                    WithdrawalService -> WithdrawalFirestore : Delete(withdrawalID)
                    activate WithdrawalFirestore
                    WithdrawalFirestore --> WithdrawalService : (ignore error for this rollback attempt)
                    deactivate WithdrawalFirestore
                    WithdrawalService --> AccountPutWithdrawalHandler : Error
                    AccountPutWithdrawalHandler --> Requester : HTTP Error Response
                else Update Account Balance Succeeded
                    WithdrawalService --> AccountPutWithdrawalHandler : withdrawalID
                    AccountPutWithdrawalHandler --> Requester : HTTP 200 OK (withdrawalID)
                end
                deactivate WithdrawalService
            end
            deactivate AccountPutWithdrawalHandler
        end
    end
end
deactivate Requester
@enduml