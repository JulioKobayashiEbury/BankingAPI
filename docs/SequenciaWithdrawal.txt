@startuml
note top
    Complete Authentication Sequence before following this diagram
end note

participant accountOwner as accountOwner
boundary accountHandler as accountHandler
boundary userHandler as userHandler
entity account as account
entity withdrawal as withdrawal
entity repository as repository
control service as service
control accountHandler as accountHandler
database firestore as firestore

accountOwner -> accountHandler : /accounts/:account_id/balance/withdrawal
accountHandler -> accountHandler : AccountPutWithdrawalHandler
accountHandler -> userHandler : userAuthorization
userHandler -> service : Authorize
service -> userHandler : model.Claims, http.Cookie
userHandler -> accountHandler : string
accountHandler -> service : ProcessWithdrawal
service -> service : Account()
service -> account : Get()
account -> service : account.AccountResponse
service -> service : account.AccountResponse

service -> withdrawal : Create()
withdrawal -> repository : GetFireStoreClient()
repository -> firestore: NewClient()
firestore -> repository : firestore.Client
repository -> withdrawal : firestore.Client
withdrawal -> firestore : .Collection().Add()
firestore -> withdrawal : firestore.DocumentRef

service -> account : AddUpdate()
service -> account : AddUpdate()
service -> account : Update()
alt Error
service -> withdrawal : Delete()
end

service -> accountHandler : model.Erro
alt No errors
accountHandler -> accountOwner : http.StatusAccepted
else Error found
accountHandler -> accountOwner : http.(ApropriateErrorCode)
end
@enduml