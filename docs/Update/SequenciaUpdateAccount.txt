@startuml
title Update Account - PUT /accounts/:account_id

actor Requester
boundary AccountPutHandler <<accountHandler.go>>
control AuthorizeService <<serviceAuthorize.go>>
control AccountService <<serviceAccount.go>>
entity AccountFirestore <<model/account/firestore.go>>

activate Requester
Requester -> AccountPutHandler : PUT /accounts/:account_id (Body: Account Info)
activate AccountPutHandler

AccountPutHandler -> AuthorizeService : Authorize(Cookie)
activate AuthorizeService
AuthorizeService -->> AccountPutHandler : Claims / Error
deactivate AuthorizeService

alt Authorization Failed
    AccountPutHandler -->> Requester : HTTP Error Response
else Authorization Succeeded

    AccountPutHandler -> AccountService : UpdateAccount(accountRequest with Account_id from path)
    activate AccountService
    AccountService -> AccountService : Account(accountRequest.Account_id)
    AccountService -> AccountFirestore : Get(&accountRequest.Account_id)
    activate AccountFirestore
    AccountFirestore -->> AccountService : existingAccountData / Error
    deactivate AccountFirestore
    
    alt Get Existing Account Failed
        AccountService -->> AccountService : Error
        AccountService -->> AccountPutHandler : Error
        AccountPutHandler -->> Requester : HTTP Error Response
    else Get Existing Account Succeeded
        AccountService -->> AccountService : accountResponse (existing data)
        note right of AccountService : Updates fields in accountResponse if provided in accountRequest
        AccountService -> AccountFirestore : Update(updatedAccountResponse)
        activate AccountFirestore
        AccountFirestore -->> AccountService : nil / Error
        deactivate AccountFirestore
        
        alt Update Account Record Failed
            AccountService -->> AccountPutHandler : Error
            AccountPutHandler -->> Requester : HTTP Error Response
        else Update Account Record Succeeded
            AccountService -> AccountService : Account(accountRequest.Account_id) 'Re-fetch updated
            AccountService -> AccountFirestore : Get(&accountRequest.Account_id)
            activate AccountFirestore
            AccountFirestore -->> AccountService : finalAccountData / Error
            deactivate AccountFirestore
            
            alt Re-fetch Failed
                 AccountService -->> AccountService : Error
                 AccountService -->> AccountPutHandler : Error (but update was likely successful)
                 AccountPutHandler -->> Requester : HTTP Error Response
            else Re-fetch Succeeded
                 AccountService -->> AccountService : finalAccount
                 AccountService -->> AccountPutHandler : finalAccount
                 AccountPutHandler -->> Requester : HTTP 200 OK (finalAccount)
            end
            deactivate AccountService
        end
    end
end
deactivate AccountPutHandler
deactivate Requester
@enduml