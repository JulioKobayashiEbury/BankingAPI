@startuml
title Update User - PUT /users/:user_id

actor Requester
boundary UserPutHandler <<userHandler.go>>
control AuthorizeService <<serviceAuthorize.go>>
control UserService <<serviceUser.go>>
entity UserFirestore <<model/user/firestore.go>>

activate Requester
Requester -> UserPutHandler : PUT /users/:user_id (Body: User Info)
activate UserPutHandler

UserPutHandler -> AuthorizeService : Authorize(Cookie)
activate AuthorizeService
AuthorizeService -->> UserPutHandler : Claims (userIDFromClaims) / Error
deactivate AuthorizeService

alt Authorization Failed (or user_id mismatch with claims.Id)
    UserPutHandler -->> Requester : HTTP Error Response
else Authorization Succeeded

    UserPutHandler -> UserService : UpdateUser(userRequest with User_id from path/claims)
    activate UserService
    UserService -> UserService : User(userRequest.User_id)
    UserService -> UserFirestore : Get(&userRequest.User_id)
    activate UserFirestore
    UserFirestore -->> UserService : existingUserData / Error
    deactivate UserFirestore
    
    alt Get Existing User Failed
        UserService -->> UserService : Error
        UserService -->> UserPutHandler : Error
        UserPutHandler -->> Requester : HTTP Error Response
    else Get Existing User Succeeded
        UserService -->> UserService : userResponse ()
        note right of UserService : Updates fields in userResponse if provided in userRequest
        UserService -> UserFirestore : Update(updatedUserResponse)
        activate UserFirestore
        UserFirestore -->> UserService : nil / Error
        deactivate UserFirestore
        
        alt Update User Record Failed
            UserService -->> UserPutHandler : Error
            UserPutHandler -->> Requester : HTTP Error Response
        else Update User Record Succeeded
            UserService -> UserService : User(userRequest.User_id) 'Re-fetch updated
            UserService -> UserFirestore : Get(&userRequest.User_id)
            activate UserFirestore
            UserFirestore -->> UserService : finalUserData / Error
            deactivate UserFirestore
            
            alt Re-fetch Failed
                 UserService -->> UserService : Error
                 UserService -->> UserPutHandler : Error
                 UserPutHandler -->> Requester : HTTP Error Response
            else Re-fetch Succeeded
                 UserService -->> UserService : finalUser
                 UserService -->> UserPutHandler : finalUser
                 UserPutHandler -->> Requester : HTTP 200 OK (finalUser)
            end
            deactivate UserService
        end
    end
end
deactivate UserPutHandler
deactivate Requester
@enduml