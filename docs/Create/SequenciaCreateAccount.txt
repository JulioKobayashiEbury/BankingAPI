@startuml
title Create Account - POST /accounts

actor Requester
boundary AccountPostHandler <<accountHandler.go>>
control AccountService <<serviceAccount.go>>
entity UserFirestore <<model/user/firestore.go>>
entity ClientFirestore <<model/client/firestore.go>>
entity AccountFirestore <<model/account/firestore.go>>

Requester -> AccountPostHandler : POST /accounts (Body: Account Info)
activate AccountPostHandler

AccountPostHandler -> AccountService : CreateAccount(accountRequest)
activate AccountService

alt Missing Credentials (User_id or Client_id)
    AccountService -->> AccountPostHandler : Error (Missing credentials)
    AccountPostHandler -->> Requester : HTTP Error Response
else
    AccountService -> UserFirestore : Get(&accountRequest.User_id)
    activate UserFirestore
    UserFirestore -->> AccountService : userData / Error (IDnotFound or other)
    deactivate UserFirestore
    
    alt User Not Found or Error
        AccountService -->> AccountPostHandler : Error
        AccountPostHandler -->> Requester : HTTP Error Response
    else User Exists
        AccountService -> ClientFirestore : Get(&accountRequest.Client_id)
        activate ClientFirestore
        ClientFirestore -->> AccountService : clientData / Error (IDnotFound or other)
        deactivate ClientFirestore
        
        alt Client Not Found or Error
            AccountService -->> AccountPostHandler : Error
            AccountPostHandler -->> Requester : HTTP Error Response
        else Client Exists
            AccountService -> AccountFirestore : Create(accountRequest)
            activate AccountFirestore
            AccountFirestore -->> AccountService : accountID_ptr / Error
            deactivate AccountFirestore
            
            alt Create Account Record Failed
                AccountService -->> AccountPostHandler : Error
                AccountPostHandler -->> Requester : HTTP Error Response
            else Create Account Record Succeeded
                AccountService -> AccountService : Account(*accountID_ptr)
                AccountService -> AccountFirestore : Get(*accountID_ptr)
                activate AccountFirestore
                AccountFirestore -->> AccountService : createdAccountData / Error
                deactivate AccountFirestore
                
                alt Get Created Account Failed
                    AccountService -->> AccountService : Error
                    AccountService -->> AccountPostHandler : Error
                    AccountPostHandler -->> Requester : HTTP Error Response
                else Get Created Account Succeeded
                    AccountService -->> AccountService : createdAccount
                    AccountService -->> AccountPostHandler : createdAccount
                    AccountPostHandler -->> Requester : HTTP 201 Created (createdAccount)
                end
            end
        end
    end
end
deactivate AccountService
deactivate AccountPostHandler