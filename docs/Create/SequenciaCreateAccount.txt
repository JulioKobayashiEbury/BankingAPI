@startuml
title Create Account - POST /accounts

actor Requester
boundary AccountPostHandler <<accountHandler.go>>
control CreateService <<serviceCreateTypes.go>>
control GetService <<serviceGetTypes.go>>
entity UserFirestore <<model/user/firestore.go>>
entity ClientFirestore <<model/client/firestore.go>>
entity AccountFirestore <<model/account/firestore.go>>

Requester -> AccountPostHandler : POST /accounts (Body: Account Info)
activate AccountPostHandler

AccountPostHandler -> CreateService : CreateAccount(accountRequest)
activate CreateService

alt Missing Credentials (User_id or Client_id)
    CreateService -->> AccountPostHandler : Error (Missing credentials)
    AccountPostHandler -->> Requester : HTTP Error Response
else
    CreateService -> UserFirestore : Get(&accountRequest.User_id)
    activate UserFirestore
    UserFirestore -->> CreateService : userData / Error (IDnotFound or other)
    deactivate UserFirestore
    
    alt User Not Found or Error
        CreateService -->> AccountPostHandler : Error
        AccountPostHandler -->> Requester : HTTP Error Response
    else User Exists
        CreateService -> ClientFirestore : Get(&accountRequest.Client_id)
        activate ClientFirestore
        ClientFirestore -->> CreateService : clientData / Error (IDnotFound or other)
        deactivate ClientFirestore
        
        alt Client Not Found or Error
            CreateService -->> AccountPostHandler : Error
            AccountPostHandler -->> Requester : HTTP Error Response
        else Client Exists
            CreateService -> AccountFirestore : Create(accountRequest)
            activate AccountFirestore
            AccountFirestore -->> CreateService : accountID_ptr / Error
            deactivate AccountFirestore
            
            alt Create Account Record Failed
                CreateService -->> AccountPostHandler : Error
                AccountPostHandler -->> Requester : HTTP Error Response
            else Create Account Record Succeeded
                CreateService -> GetService : Account(*accountID_ptr)
                activate GetService
                GetService -> AccountFirestore : Get(*accountID_ptr)
                activate AccountFirestore
                AccountFirestore -->> GetService : createdAccountData / Error
                deactivate AccountFirestore
                
                alt Get Created Account Failed
                    GetService -->> CreateService : Error
                    deactivate GetService
                    CreateService -->> AccountPostHandler : Error
                    AccountPostHandler -->> Requester : HTTP Error Response
                else Get Created Account Succeeded
                    GetService -->> CreateService : createdAccount
                    deactivate GetService
                    CreateService -->> AccountPostHandler : createdAccount
                    deactivate CreateService
                    AccountPostHandler -->> Requester : HTTP 201 Created (createdAccount)
                end
            end
        end
    end
end
deactivate AccountPostHandler
@enduml